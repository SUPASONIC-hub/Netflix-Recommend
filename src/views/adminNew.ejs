<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>새 추천 등록</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Nanum Gothic', system-ui, -apple-system, BlinkMacSystemFont,
          'Segoe UI', sans-serif;
        font-size: 14px;
        background-color: #ffffff;
        color: #212529;
      }
      .navbar-brand {
        font-weight: 700;
      }
    </style>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
    <script>
      async function searchTmdb() {
        const q = document.getElementById('searchQuery').value.trim();
        const listEl = document.getElementById('searchResults');
        listEl.innerHTML = '';
        if (!q) return;

        try {
          const res = await fetch('/api/tmdb/search?q=' + encodeURIComponent(q));
          const data = await res.json();

          if (data && data.error) {
            alert('검색 중 오류: ' + data.error);
            return;
          }

          if (!Array.isArray(data) || data.length === 0) {
            listEl.innerHTML = '<p>검색 결과가 없습니다.</p>';
            return;
          }

          data.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'card mb-2';
            div.innerHTML = `
              <div class="card-body d-flex">
                ${
                  item.posterUrl
                    ? `<img src="${item.posterUrl}" style="height:80px" class="me-3" />`
                    : ''
                }
                <div class="flex-grow-1">
                  <h5 class="card-title">${item.title}</h5>
                  <p class="card-text">${item.pubDate || ''}</p>
                  <button type="button" class="btn btn-sm btn-primary">선택하기</button>
                </div>
              </div>
            `;
            div.querySelector('button').addEventListener('click', () => {
              document.getElementById('tmdbId').value = item.tmdbId;
              document.getElementById('title').value = item.title;
              document.getElementById('posterUrl').value = item.posterUrl || '';
              document.getElementById('year').value = item.pubDate || '';
              document.getElementById('type').value = 'movie';

              // 모달 닫기
              const modalEl = document.getElementById('searchModal');
              const modal = bootstrap.Modal.getInstance(modalEl);
              if (modal) {
                modal.hide();
              }
            });
            listEl.appendChild(div);
          });

          // 검색 결과가 있으면 모달 보여주기
          const modalEl = document.getElementById('searchModal');
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        } catch (e) {
          console.error(e);
          alert('TMDB 검색 요청 중 오류가 발생했습니다. 콘솔을 확인해주세요.');
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('searchQuery');
        if (input) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              searchTmdb();
            }
          });
        }
      });
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 border-bottom">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">넷플릭스 추천</a>
        <div class="d-flex">
          <a href="/" class="btn btn-outline-light btn-sm">목록으로</a>
        </div>
      </div>
    </nav>

    <div class="container mb-5">
      <h1 class="mb-3">새 추천 등록</h1>

      <div class="mb-4">
        <label class="form-label">TMDB 콘텐츠 검색</label>
        <div class="input-group mb-2">
          <input
            type="text"
            id="searchQuery"
            class="form-control"
            placeholder="작품 제목을 입력하세요"
          />
          <button type="button" class="btn btn-primary" onclick="searchTmdb()">
            검색
          </button>
        </div>
      </div>

      <!-- 검색 결과 모달 -->
      <div
        class="modal fade"
        id="searchModal"
        tabindex="-1"
        aria-labelledby="searchModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="searchModalLabel">TMDB 검색 결과</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div id="searchResults"></div>
            </div>
          </div>
        </div>
      </div>

      <hr class="border-secondary" />

      <form method="post" action="/admin/content">
        <h3 class="mb-3">선택한 작품 + 나만의 감상</h3>
        <input type="hidden" id="tmdbId" name="tmdbId" />
        <div class="mb-3">
          <label class="form-label">제목</label>
          <input type="text" id="title" name="title" class="form-control" readonly />
        </div>
        <div class="mb-3">
          <label class="form-label">포스터 URL</label>
          <input type="text" id="posterUrl" name="posterUrl" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">연도</label>
          <input type="text" id="year" name="year" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">타입</label>
          <input type="text" id="type" name="type" class="form-control" value="movie" />
        </div>
        <div class="mb-3">
          <label class="form-label">나의 감상</label>
          <textarea name="myNote" class="form-control" rows="4" required></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">별점 (0.5 ~ 5)</label>
          <input
            type="number"
            step="0.5"
            min="0.5"
            max="5"
            name="myRating"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label class="form-label">태그 (쉼표로 구분)</label>
          <input
            type="text"
            name="tags"
            class="form-control"
            placeholder="예: 힐링, 스릴러, 같이보면좋은"
          />
        </div>
        <button type="submit" class="btn btn-primary">등록하기</button>
      </form>
    </div>
  </body>
  </html>

