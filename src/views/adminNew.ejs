<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>추천 등록</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Nanum Gothic', system-ui, -apple-system, BlinkMacSystemFont,
          'Segoe UI', sans-serif;
        font-size: 14px;
        background-color: #ffffff;
        color: #212529;
      }
      .navbar-brand {
        font-weight: 700;
      }
      @media (max-width: 575.98px) {
        body {
          font-size: 13px;
        }
        .navbar .container-fluid {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }
        .navbar .btn {
          width: 100%;
        }
        .modal-dialog {
          margin: 1rem;
        }
        .table-responsive .btn,
        .table-responsive form {
          width: 100%;
        }
        .table-responsive .d-flex {
          flex-direction: column;
        }
      }
    </style>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
    <script>
      async function searchTmdb() {
        const q = document.getElementById('searchQuery').value.trim();
        const listEl = document.getElementById('searchResults');
        listEl.innerHTML = '';
        if (!q) return;

        try {
          const res = await fetch('/api/tmdb/search?q=' + encodeURIComponent(q));
          const data = await res.json();

          if (data && data.error) {
            alert('검색 중 오류: ' + data.error);
            return;
          }

          if (!Array.isArray(data) || data.length === 0) {
            listEl.innerHTML = '<p>검색 결과가 없습니다.</p>';
            return;
          }

          data.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'card mb-2';
            div.innerHTML = `
              <div class="card-body d-flex">
                ${
                  item.posterUrl
                    ? `<img src="${item.posterUrl}" style="height:80px" class="me-3" />`
                    : ''
                }
                <div class="flex-grow-1">
                  <h5 class="card-title">${item.title}</h5>
                  <p class="card-text">${item.pubDate || ''}</p>
                  <button type="button" class="btn btn-sm btn-primary">선택하기</button>
                </div>
              </div>
            `;
            div.querySelector('button').addEventListener('click', () => {
              document.getElementById('tmdbId').value = item.tmdbId;
              document.getElementById('title').value = item.title || item.name || '';
              document.getElementById('name').value = item.name || '';
              document.getElementById('overview').value = item.overview || '';
              document.getElementById('releaseDate').value = item.releaseDate || '';
              document.getElementById('firstAirDate').value = item.firstAirDate || '';
              document.getElementById('posterPath').value = item.posterPath || '';
              document.getElementById('posterUrl').value = item.posterUrl || '';
              document.getElementById('backdropPath').value = item.backdropPath || '';
              document.getElementById('genreIds').value = JSON.stringify(
                Array.isArray(item.genreIds) ? item.genreIds : []
              );
              document.getElementById('popularity').value =
                item.popularity !== null && item.popularity !== undefined
                  ? String(item.popularity)
                  : '';
              document.getElementById('voteAverage').value =
                item.voteAverage !== null && item.voteAverage !== undefined
                  ? String(item.voteAverage)
                  : '';
              document.getElementById('voteCount').value =
                item.voteCount !== null && item.voteCount !== undefined
                  ? String(item.voteCount)
                  : '';
              document.getElementById('adult').value = item.adult ? 'true' : 'false';
              document.getElementById('mediaType').value = item.mediaType || '';
              document.getElementById('year').value = item.pubDate || '';
              document.getElementById('type').value = item.mediaType || 'movie';

              // 모달 닫기
              const modalEl = document.getElementById('searchModal');
              const modal = bootstrap.Modal.getInstance(modalEl);
              if (modal) {
                modal.hide();
              }
            });
            listEl.appendChild(div);
          });

          // 검색 결과가 있으면 모달 보여주기
          const modalEl = document.getElementById('searchModal');
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        } catch (e) {
          console.error(e);
          alert('TMDB 검색 요청 중 오류가 발생했습니다. 콘솔을 확인해 주세요.');
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('searchQuery');
        if (input) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              searchTmdb();
            }
          });
        }
      });
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 border-bottom">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">넷플릭스 추천</a>
        <div class="d-flex">
          <a href="/" class="btn btn-outline-light btn-sm">목록으로</a>
        </div>
      </div>
    </nav>

    <div class="container mb-5">
      <h1 class="mb-3">추천 등록</h1>

      <div class="mb-4">
        <label class="form-label">TMDB 콘텐츠 검색</label>
        <div class="input-group mb-2">
          <input
            type="text"
            id="searchQuery"
            class="form-control"
            placeholder="작품 제목을 입력하세요"
          />
          <button type="button" class="btn btn-primary" onclick="searchTmdb()">
            검색
          </button>
        </div>
      </div>

      <div
        class="modal fade"
        id="searchModal"
        tabindex="-1"
        aria-labelledby="searchModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="searchModalLabel">TMDB 검색 결과</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div id="searchResults"></div>
            </div>
          </div>
        </div>
      </div>

      <hr class="border-secondary" />

      <form method="post" action="/admin/content">
        <h3 class="mb-3">선택한 작품 + 나만의 감상</h3>
        <input type="hidden" id="tmdbId" name="tmdbId" />
        <input type="hidden" id="name" name="name" />
        <input type="hidden" id="overview" name="overview" />
        <input type="hidden" id="releaseDate" name="releaseDate" />
        <input type="hidden" id="firstAirDate" name="firstAirDate" />
        <input type="hidden" id="posterPath" name="posterPath" />
        <input type="hidden" id="backdropPath" name="backdropPath" />
        <input type="hidden" id="genreIds" name="genreIds" />
        <input type="hidden" id="popularity" name="popularity" />
        <input type="hidden" id="voteAverage" name="voteAverage" />
        <input type="hidden" id="voteCount" name="voteCount" />
        <input type="hidden" id="adult" name="adult" />
        <input type="hidden" id="mediaType" name="mediaType" />
        <div class="mb-3">
          <label class="form-label">제목</label>
          <input type="text" id="title" name="title" class="form-control" readonly />
        </div>
        <div class="mb-3">
          <label class="form-label">포스터 URL</label>
          <input type="text" id="posterUrl" name="posterUrl" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">연도</label>
          <input type="text" id="year" name="year" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">타입</label>
          <input type="text" id="type" name="type" class="form-control" value="movie" />
        </div>
        <div class="mb-3">
          <label class="form-label">나의 감상</label>
          <textarea name="myNote" class="form-control" rows="4" required></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">별점 (0.5 ~ 5)</label>
          <input
            type="number"
            step="0.5"
            min="0.5"
            max="5"
            name="myRating"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label class="form-label">태그 (쉼표로 구분)</label>
          <input
            type="text"
            name="tags"
            class="form-control"
            placeholder="예: 스릴러, 가족, 주말에 보기 좋음"
          />
        </div>
        <button type="submit" class="btn btn-primary">등록하기</button>
      </form>

      <hr class="border-secondary my-5" />

      <section>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="mb-0">기존 추천 목록 관리</h3>
          <span class="badge bg-secondary">총 <%= Array.isArray(contents) ? contents.length : 0 %>개</span>
        </div>
        <form method="get" action="/admin/new" class="row g-2 align-items-center mb-3">
          <div class="col-12 col-md-6">
            <input
              type="text"
              name="manageQ"
              class="form-control"
              placeholder="제목 검색..."
              value="<%= manageQuery || '' %>"
            />
          </div>
          <div class="col-12 col-md-3">
            <select name="manageSort" class="form-select">
              <option value="latest" <%= manageSort === 'latest' ? 'selected' : '' %>>최신순</option>
              <option value="rating" <%= manageSort === 'rating' ? 'selected' : '' %>>평점순</option>
            </select>
          </div>
          <div class="col-12 col-md-auto">
            <button type="submit" class="btn btn-primary">적용</button>
            <a href="/admin/new" class="btn btn-outline-secondary ms-2">초기화</a>
          </div>
        </form>

        <% if (!contents || contents.length === 0) { %>
        <p class="text-muted">등록된 추천이 없습니다.</p>
        <% } else { %>
        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 70px;">포스터</th>
                <th>제목</th>
                <th style="width: 110px;">타입</th>
                <th style="width: 90px;">평점</th>
                <th style="width: 220px;">관리</th>
              </tr>
            </thead>
            <tbody>
              <% contents.forEach(function (c) { %>
              <tr>
                <td class="text-center">
                  <% const poster = c.posterUrl || (c.posterPath ? 'https://image.tmdb.org/t/p/w92' + c.posterPath : ''); %>
                  <% if (poster) { %>
                  <img
                    src="<%= poster %>"
                    alt="<%= c.title || c.name || '' %>"
                    style="width: 52px; height: 78px; object-fit: cover; border-radius: 4px;"
                  />
                  <% } else { %>
                  <span class="text-muted small">없음</span>
                  <% } %>
                </td>
                <td>
                  <div class="fw-bold"><%= c.title || c.name || '' %></div>
                  <div class="text-muted small"><%= c.year || '' %></div>
                </td>
                <td><%= c.type || c.mediaType || '-' %></td>
                <td><%= typeof c.myRating === 'number' ? c.myRating : '-' %></td>
                <td>
                  <div class="d-flex gap-2">
                    <a href="/content/<%= c.id %>" class="btn btn-sm btn-outline-primary">상세</a>
                    <a href="/admin/content/<%= c.id %>/edit" class="btn btn-sm btn-outline-secondary">수정</a>
                    <form
                      method="post"
                      action="/admin/content/<%= c.id %>/delete"
                      onsubmit="return confirm('이 추천을 삭제할까요?');"
                      class="d-inline"
                    >
                      <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
                    </form>
                  </div>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
        <% } %>
      </section>
    </div>
  </body>
</html>
